name: Migrate QA Database

on:
  push:
    branches: [main]
    paths:
      - 'supabase/migrations/**'
  workflow_dispatch: # Allow manual triggering

jobs:
  migrate-qa:
    name: Apply Migrations to QA
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to QA Supabase
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_QA_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Apply migrations to QA
        run: |
          echo "ğŸ“‹ Migrations to apply:"
          supabase migration list
          echo ""
          echo "ğŸ”„ Applying migrations to QA..."
          echo "y" | supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_QA_DB_PASSWORD }}

      - name: Verify QA migrations
        run: |
          echo "âœ… QA Migration Status:"
          supabase migration list
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: QA Testing Instructions
        run: |
          echo ""
          echo "âœ… Migrations applied to QA successfully!"
          echo "ğŸŒ Test on: https://divij-qa.tech"
          echo ""
          echo "ğŸ“‹ Testing Checklist:"
          echo "  âœ… Verify schema changes"
          echo "  âœ… Test affected features"
          echo "  âœ… Check for errors"
          echo "  âœ… Ensure data integrity"
          echo ""
          echo "ğŸš€ When QA testing passes:"
          echo "  â†’ Go to: https://github.com/divijshrivastava/portfolio-v2/actions/workflows/migrate-production.yml"
          echo "  â†’ Click 'Run workflow'"
          echo "  â†’ Migrations will apply to production"
